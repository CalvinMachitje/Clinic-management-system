{% extends "base.html" %}
{% block title %}Staff Scheduling{% endblock %}

{% block styles %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
  #calendar { max-width: 1100px; margin: 40px auto; }
  .fc-event { cursor: move; }
  .shift-morning { background-color: #28a745; border-color: #218838; }
  .shift-afternoon { background-color: #ffc107; border-color: #e0a800; color: #212529; }
  .shift-night { background-color: #007bff; border-color: #0069d9; }
  .btn-group { margin: 1rem 0; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Staff Scheduling</h1>
  <div class="btn-group">
    <button id="export-pdf" class="btn btn-primary">Export PDF</button>
    <button id="export-csv" class="btn btn-secondary">Export CSV</button>
  </div>
</div>

<div id="calendar"></div>

<!-- Shift Assignment Modal -->
<dialog id="shiftModal">
  <form method="dialog" id="shiftForm">
    <h3>Assign Shift</h3>
    <input type="hidden" id="eventId">
    <div class="form-group">
      <label>Staff Member</label>
      <select id="employee_id" required>
        {% for emp in staff %}
        <option value="{{ emp.id }}">{{ emp.first_name }} {{ emp.last_name }} ({{ emp.role | capitalize }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" id="shift_date" required>
    </div>
    <div class="form-group">
      <label>Shift</label>
      <select id="shift_type" required>
        <option value="morning">Morning (08:00 - 16:00)</option>
        <option value="afternoon">Afternoon (13:00 - 21:00)</option>
        <option value="night">Night (20:00 - 08:00)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="notes"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
    <button type="button" onclick="closeModal('shiftModal')" class="btn btn-secondary">Cancel</button>
  </form>
</dialog>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');
  const modal = document.getElementById('shiftModal');
  const form = document.getElementById('shiftForm');
  let calendar;

  function showAlert(message, type = 'danger') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded shadow-lg`;
    alert.innerHTML = `${message} <button class="float-right">&times;</button>`;
    document.body.appendChild(alert);
    alert.querySelector('button').onclick = () => alert.remove();
    setTimeout(() => alert.remove(), 5000);
  }

  function initCalendar() {
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
      editable: true,
      droppable: true,
      events: '/get_schedule',
      eventClick: function(info) {
        document.getElementById('eventId').value = info.event.id;
        document.getElementById('employee_id').value = info.event.extendedProps.employee_id;
        document.getElementById('shift_date').value = info.event.startStr.split('T')[0];
        document.getElementById('shift_type').value = info.event.extendedProps.shift_type;
        document.getElementById('notes').value = info.event.extendedProps.notes || '';
        modal.showModal();
      },
      eventDrop: function(info) {
        updateEvent(info.event);
      },
      dateClick: function(info) {
        document.getElementById('eventId').value = '';
        document.getElementById('shift_date').value = info.dateStr;
        modal.showModal();
      }
    });
    calendar.render();
  }

  initCalendar();

  form.onsubmit = async function(e) {
    e.preventDefault();
    const data = {
      id: document.getElementById('eventId').value,
      employee_id: document.getElementById('employee_id').value,
      shift_date: document.getElementById('shift_date').value,
      shift_type: document.getElementById('shift_type').value,
      notes: document.getElementById('notes').value
    };

    const response = await fetch('/save_shift', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      modal.close();
      calendar.refetchEvents();
      showAlert('Shift saved successfully!', 'success');
    } else {
      const result = await response.json();
      showAlert(`Error: ${result.message || 'Conflict!'}`, 'danger');
    }
  };

  function updateEvent(event) {
    fetch('/update_shift_date', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: event.id, shift_date: event.startStr.split('T')[0] })
    });
  }

  // Export buttons
  document.getElementById('export-pdf').onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text('Staff Schedule - Township Clinic', 20, 20);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
    doc.save('staff-schedule.pdf');
  };

  document.getElementById('export-csv').onclick = () => {
    fetch('/get_schedule').then(r => r.json()).then(events => {
      let csv = 'Staff,Date,Shift,Notes\n';
      events.forEach(e => {
        csv += `"${e.title}","${e.start.split('T')[0]}","${e.extendedProps.shift_type}","${e.extendedProps.notes || ''}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'staff-schedule.csv'; a.click();
    });
  };
});
</script>
{% endblock %}