{% extends "base.html" %}

{% block content %}
<div class="dashboard-content">
    <h2>Manage Appointments</h2>

    <!-- Booking Section -->
    <div class="manage-appointments">
        <div class="card">
            <h3>Book New Appointment</h3>
            <form id="bookingForm">
                <div class="form-group">
                    <label for="patientId">Patient ID</label>
                    <input type="text" id="patientId" name="patient_id" class="form-control" required />
                </div>
                <div class="form-group">
                    <label for="appointmentTime">Appointment Date & Time</label>
                    <input type="datetime-local" id="appointmentTime" name="appointment_time" class="form-control" required />
                </div>
                <div class="form-group">
                    <label for="reasonInput">Reason (optional)</label>
                    <input type="text" id="reasonInput" name="reason" class="form-control" placeholder="Reason for appointment" />
                </div>
                <button type="submit" class="btn btn-primary">Book Appointment</button>
                <div id="formMessage" style="margin-top: 10px;"></div>
            </form>
        </div>
    </div>

    <!-- Filter for appointment status -->
    <div class="manage-appointments" style="margin-top: 20px;">
        <label for="statusFilter" style="font-weight: 600; margin-bottom: 8px; display: block;">Filter by Status:</label>
        <select id="statusFilter" class="form-control" style="max-width: 300px;">
            <option value="all">All</option>
            <option value="open">Open (scheduled/waiting)</option>
            <option value="rescheduled">Rescheduled</option>
            <option value="missed">Missed</option>
            <option value="cancelled">Cancelled</option>
        </select>
    </div>

    <!-- Appointments Table -->
    <div class="manage-appointments" style="margin-top: 15px;">
        <div class="card">
            <h3>Appointments</h3>
            <table class="table" id="appointmentsTable">
                <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Date & Time</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Assigned Staff</th>
                        <!-- Actions column can be added if needed -->
                    </tr>
                </thead>
                <tbody>
                    {% for appt in appointments %}
                    <tr data-status="{{ appt.status|lower }}" class="{% if appt.status in ['rescheduled', 'cancelled'] %}urgent{% endif %}">
                        <td>{{ appt.first_name }} {{ appt.last_name }}</td>
                        <td>{{ appt.appointment_date }}</td>
                        <td>{{ appt.status|capitalize }}</td>
                        <td>{{ appt.reason }}</td>
                        <td>
                            {% if appt.helper_name %}
                                {{ appt.helper_name }} ({{ appt.helper_role }})
                            {% else %}
                                <em>Unassigned</em>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const bookingForm = document.getElementById('bookingForm');
    const formMessage = document.getElementById('formMessage');
    const appointmentsTable = document.getElementById('appointmentsTable').getElementsByTagName('tbody')[0];
    const statusFilter = document.getElementById('statusFilter');

    // Handle booking form submission with AJAX
    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        formMessage.textContent = '';
        formMessage.style.color = '';

        const formData = new FormData(bookingForm);
        try {
            const response = await fetch('{{ url_for("manage_appointments") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            if (data.success) {
                formMessage.style.color = 'green';
                formMessage.textContent = data.message;

                // Append new appointment row to table
                const appt = data.appointment;
                const newRow = appointmentsTable.insertRow(0);
                newRow.setAttribute('data-status', appt.status.toLowerCase());
                if (['rescheduled', 'cancelled'].includes(appt.status.toLowerCase())) {
                    newRow.classList.add('urgent');
                }
                newRow.innerHTML = `
                    <td>${appt.patient_first_name || 'Unknown'} ${appt.patient_last_name || ''}</td>
                    <td>${appt.appointment_date}</td>
                    <td>${appt.status.charAt(0).toUpperCase() + appt.status.slice(1)}</td>
                    <td>${appt.reason || 'Not specified'}</td>
                    <td><em>Unassigned</em></td>
                `;
                // Clear form inputs
                bookingForm.reset();
            } else {
                formMessage.style.color = 'red';
                formMessage.textContent = data.message || 'Failed to book appointment';
            }
        } catch (error) {
            formMessage.style.color = 'red';
            formMessage.textContent = 'An error occurred while booking appointment.';
            console.error('Booking error:', error);
        }
    });

    // Filter appointments table rows by status
    statusFilter.addEventListener('change', () => {
        const selected = statusFilter.value;
        Array.from(appointmentsTable.rows).forEach(row => {
            const status = row.getAttribute('data-status');
            if (selected === 'all') {
                row.style.display = '';
            } else if (selected === 'open') {
                row.style.display = (status === 'scheduled' || status === 'waiting') ? '' : 'none';
            } else {
                row.style.display = (status === selected) ? '' : 'none';
            }
        });
    });
});
</script>
{% endblock %}
