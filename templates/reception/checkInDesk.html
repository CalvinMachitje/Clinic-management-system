{% extends 'base.html' %}
{% block title %}Check-In Desk - Township Clinic{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8 dashboard-content">
    <h2 class="text-3xl font-bold mb-8">Check-In Desk</h2>
    <h3 class="text-2xl font-semibold mb-4">Scheduled Appointments</h3>
    {% if scheduled_appointments %}
    <table class="w-full table-auto border-collapse table mb-8">
        <thead class="bg-gray-100">
            <tr>
                <th class="px-4 py-2 text-left">ID</th>
                <th class="px-4 py-2 text-left">Patient</th>
                <th class="px-4 py-2 text-left">Date</th>
                <th class="px-4 py-2 text-left">Status</th>
                <th class="px-4 py-2 text-left">Reason</th>
                <th class="px-4 py-2 text-left">Helper</th>
                <th class="px-4 py-2 text-left">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for appt in scheduled_appointments %}
            <tr class="hover:bg-gray-50" data-appointment-id="{{ appt.id }}">
                <td class="px-4 py-2">{{ appt.id }}</td>
                <td class="px-4 py-2">{{ appt.first_name }} {{ appt.last_name }}</td>
                <td class="px-4 py-2">{{ appt.appointment_date }}</td>
                <td class="px-4 py-2">{{ appt.status }}</td>
                <td class="px-4 py-2">{{ appt.reason }}</td>
                <td class="px-4 py-2">{{ appt.helper_name or 'None' }} ({{ appt.helper_role or 'N/A' }})</td>
                <td class="px-4 py-2">
                    {% if appt.status == 'scheduled' %}
                    <form action="{{ url_for('cancel_appointment') }}" method="POST" class="inline">
                        <input type="hidden" name="appointment_id" value="{{ appt.id }}">
                        <button type="submit" class="btn btn-danger">Cancel</button>
                    </form>
                    {% else %}
                    <span>{{ appt.status|capitalize }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center text-gray-600 mb-8">No scheduled appointments.</p>
    {% endif %}

    <h3 class="text-2xl font-semibold mb-4">Waitlist</h3>
    {% if waitlist %}
    <table class="w-full table-auto border-collapse table mb-8">
        <thead class="bg-gray-100">
            <tr>
                <th class="px-4 py-2 text-left">ID</th>
                <th class="px-4 py-2 text-left">Patient</th>
                <th class="px-4 py-2 text-left">Date</th>
                <th class="px-4 py-2 text-left">Status</th>
                <th class="px-4 py-2 text-left">Reason</th>
                <th class="px-4 py-2 text-left">Action</th>
            </tr>
        </thead>
        <tbody id="waitlist-table-body">
            {% for appt in waitlist %}
            <tr class="hover:bg-gray-50" data-appointment-id="{{ appt.id }}">
                <td class="px-4 py-2">{{ appt.id }}</td>
                <td class="px-4 py-2">{{ appt.first_name }} {{ appt.last_name }}</td>
                <td class="px-4 py-2">{{ appt.appointment_date }}</td>
                <td class="px-4 py-2">{{ appt.status }}</td>
                <td class="px-4 py-2">{{ appt.reason }}</td>
                <td class="px-4 py-2">
                    <form action="{{ url_for('assign_staff') }}" method="POST" class="inline">
                        <input type="hidden" name="appointment_id" value="{{ appt.id }}">
                        <select name="staff_id" required class="p-2 border rounded-md mr-2">
                            <option value="">Select Staff</option>
                            {% for staff in available_staff %}
                            <option value="{{ staff.staff_number }}">{{ staff.first_name }} {{ staff.last_name }} ({{ staff.role }})</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center text-gray-600 mb-8">No patients in waitlist.</p>
    {% endif %}

    <h3 class="text-2xl font-semibold mb-4">Available Staff</h3>
    {% if available_staff %}
    <ul class="space-y-2 mb-8">
        {% for staff in available_staff %}
        <li class="bg-white rounded-md p-4 shadow-sm">{{ staff.first_name }} {{ staff.last_name }} ({{ staff.role }}) - {{ staff.staff_number }}</li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-center text-gray-600 mb-8">No staff available.</p>
    {% endif %}

    <h3 class="text-2xl font-semibold mb-4">Helped Patients</h3>
    {% if helped_patients %}
    <table class="w-full table-auto border-collapse table">
        <thead class="bg-gray-100">
            <tr>
                <th class="px-4 py-2 text-left">ID</th>
                <th class="px-4 py-2 text-left">Patient</th>
                <th class="px-4 py-2 text-left">Appointment Date</th>
                <th class="px-4 py-2 text-left">Nurse</th>
                <th class="px-4 py-2 text-left">Timestamp</th>
                <th class="px-4 py-2 text-left">Reason</th>
                <th class="px-4 py-2 text-left">Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in helped_patients %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">{{ patient.id }}</td>
                <td class="px-4 py-2">{{ patient.patient_name }}</td>
                <td class="px-4 py-2">{{ patient.appointment_date }}</td>
                <td class="px-4 py-2">{{ patient.nurse_name }}</td>
                <td class="px-4 py-2">{{ patient.helped_timestamp }}</td>
                <td class="px-4 py-2">{{ patient.reason }}</td>
                <td class="px-4 py-2">{{ patient.notes }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center text-gray-600">No helped patients found.</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Fetch JSON data for React frontend
    fetch('/check_in_page', {
        headers: { 'Accept': 'application/json' },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Scheduled Appointments:', data.scheduled_appointments);
        console.log('Waitlist:', data.waitlist);
        console.log('Available Staff:', data.available_staff);
        console.log('Helped Patients:', data.helped_patients);
        // Add React logic here to render data dynamically if needed
    })
    .catch(error => console.error('Error fetching check-in data:', error));

    // SSE for real-time updates
    const source = new EventSource('/stream_appointments');
    source.onmessage = function(event) {
        try {
            const update = JSON.parse(event.data);
            console.log('Appointment update:', update);
            // Update UI (e.g., waitlist table)
            const waitlistTbody = document.getElementById('waitlist-table-body');
            if (waitlistTbody) {
                const row = waitlistTbody.querySelector(`tr[data-appointment-id="${update.id}"]`);
                if (update.status === 'helped' && row) {
                    row.remove(); // Remove from waitlist
                } else if (!row && update.status === 'waiting') {
                    // Add new waitlist entry
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-appointment-id', update.id);
                    newRow.innerHTML = `
                        <td class="px-4 py-2">${update.id}</td>
                        <td class="px-4 py-2">${update.first_name} ${update.last_name}</td>
                        <td class="px-4 py-2">${update.appointment_date}</td>
                        <td class="px-4 py-2">${update.status}</td>
                        <td class="px-4 py-2">${update.reason || 'Not specified'}</td>
                        <td class="px-4 py-2">
                            <form action="/assign_staff" method="POST" class="inline">
                                <input type="hidden" name="appointment_id" value="${update.id}">
                                <select name="staff_id" required class="p-2 border rounded-md mr-2">
                                    <option value="">Select Staff</option>
                                    {% for staff in available_staff %}
                                    <option value="{{ staff.staff_number }}">{{ staff.first_name }} {{ staff.last_name }} ({{ staff.role }})</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-primary">Assign</button>
                            </form>
                        </td>
                    `;
                    waitlistTbody.prepend(newRow);
                }
            }
        } catch (e) {
            console.error('Error processing SSE data:', e);
        }
    };
</script>
{% endblock %}