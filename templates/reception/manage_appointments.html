{% extends 'base.html' %}
{% block title %}Manage Appointments{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reception.css') }}?v=2">
{% endblock %}
{% block content %}
<div class="dashboard-content">
    <h2 class="text-3xl font-bold mb-8">Manage Appointments</h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, msg in messages %}
                <div class="flash-message {{ category }}">{{ msg }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Booking Section -->
    <div class="card">
        <h3 class="text-2xl font-semibold mb-4">Book New Appointment</h3>
        <form id="bookingForm" onsubmit="bookAppointment(event)">
            <input type="hidden" name="action" value="book_appointment">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="patientId">Patient *</label>
                <select id="patientId" name="patient_id" class="form-control" required>
                    <option value="">Select a patient</option>
                    {% for patient in patients %}
                        <option value="{{ patient.id }}"
                            {% if selected_patient_id and selected_patient_id == patient.id|string %}selected{% endif %}>
                            {{ patient.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="appointmentTime">Appointment Date & Time</label>
                <input type="datetime-local" id="appointmentTime" name="appointment_time" class="form-control" required />
            </div>
            <div class="form-group">
                <label for="reasonInput">Reason (optional)</label>
                <input type="text" id="reasonInput" name="reason" class="form-control" placeholder="Reason for appointment" />
            </div>
            <div class="form-group">
                <label for="helperId">Assign Staff (optional)</label>
                <select id="helperId" name="helper_id" class="form-control">
                    <option value="">None</option>
                    {% for staff in available_staff %}
                        <option value="{{ staff.id }}">{{ staff.name }} ({{ staff.role }})</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Book Appointment</button>
            <div id="formMessage" class="mt-4"></div>
        </form>
    </div>

    <!-- Self-Booked Appointments Section -->
    <div class="card mt-8">
        <h3 class="text-2xl font-semibold mb-4">Pending Self-Booked Appointments</h3>
        <table class="table" id="selfBookedTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Patient Name</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Date & Time</th>
                    <th>Reason</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for appt in self_booked_appointments %}
                    <tr>
                        <td>{{ appt.id }}</td>
                        <td>{{ appt.patient_name }}</td>
                        <td>{{ appt.patient_phone | default('N/A') }}</td>
                        <td>{{ appt.patient_email | default('N/A') }}</td>
                        <td>{{ appt.appointment_date }}</td>
                        <td>{{ appt.reason }}</td>
                        <td>
                            <form class="convertForm" data-id="{{ appt.id }}" onsubmit="convertSelfBooked(event)">
                                <input type="hidden" name="action" value="convert_self_booked">
                                <input type="hidden" name="self_booked_id" value="{{ appt.id }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <select name="patient_id" class="form-control" required>
                                    <option value="">Select Patient</option>
                                    {% for patient in patients %}
                                        <option value="{{ patient.id }}">{{ patient.name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="datetime-local" name="appointment_time" value="{{ appt.appointment_date | replace(' ', 'T') }}" class="form-control" required>
                                <input type="text" name="reason" value="{{ appt.reason }}" class="form-control">
                                <select name="helper_id" class="form-control" required>
                                    <option value="">Assign Staff</option>
                                    {% for staff in available_staff %}
                                        <option value="{{ staff.id }}">{{ staff.name }} ({{ staff.role }})</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-primary">Confirm</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Filter for appointment status -->
    <div class="mt-8">
        <label for="statusFilter" class="font-semibold mb-2 block">Filter by Status:</label>
        <select id="statusFilter" class="form-control max-w-xs">
            <option value="all">All</option>
            <option value="open">Open (scheduled/waiting)</option>
            <option value="rescheduled">Rescheduled</option>
            <option value="missed">Missed</option>
            <option value="cancelled">Cancelled</option>
        </select>
    </div>

    <!-- Appointments Table -->
    <div class="card mt-8">
        <h3 class="text-2xl font-semibold mb-4">Appointments</h3>
        <table class="table" id="appointmentsTable">
            <thead>
                <tr>
                    <th>Patient Name</th>
                    <th>Date & Time</th>
                    <th>Status</th>
                    <th>Reason</th>
                    <th>Assigned Staff</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for appt in appointments %}
                    <tr data = "{{ appt.status | lower }}" class="{% if appt.status in ['rescheduled', 'cancelled'] %}urgent{% endif %}">
                        <td>{{ appt.first_name }} {{ appt.last_name }}</td>
                        <td>{{ appt.appointment_date }}</td>
                        <td>{{ appt.status | capitalize }}</td>
                        <td>{{ appt.reason }}</td>
                        <td>
                            {% if appt.helper_name %}
                                {{ appt.helper_name }} ({{ appt.helper_role }}) 
                            {% else %}
                                <em>Unassigned</em>
                            {% endif %}
                        </td>
                        <td>
                            <form class="cancelForm" data-id="{{ appt.id }}" onsubmit="cancelAppointment(event)">
                                <input type="hidden" name="action" value="cancel_appointment">
                                <input type="hidden" name="appointment_id" value="{{ appt.id }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-danger">Cancel</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}