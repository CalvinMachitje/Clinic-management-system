{% extends "base.html" %}
{% block title %}Prescribe Medication - Township Clinic{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/prescription.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 prescription-container">
    <header class="mb-8">
        <h2 class="text-3xl font-bold">Prescribe Medication for {{ patient.first_name }} {{ patient.last_name }}</h2>
        <p class="text-lg text-gray-600">Patient ID: {{ patient.id }}</p>
    </header>
    <form method="POST" action="{{ url_for('prescription_page', patient_id=patient.id) }}" class="bg-white rounded-lg shadow-md p-6">
        <div class="form-group mb-4">
            <label for="nhsMedicineSearch" class="block text-sm font-medium text-gray-700">Search NHS Medicines:</label>
            <input type="text" id="nhsMedicineSearch" placeholder="Search for a medicine (e.g., paracetamol)..." autocomplete="off" class="mt-1 p-2 w-full border rounded-md">
            <div id="nhsMedicineResults" class="medicine-results mt-4 space-y-4"></div>
        </div>
        <div class="form-group mb-4">
            <label for="medication_name" class="block text-sm font-medium text-gray-700">Medication Name:</label>
            <input type="text" id="medication_name" name="medication_name" required class="mt-1 p-2 w-full border rounded-md">
        </div>
        <div class="form-group mb-4">
            <label for="dosage" class="block text-sm font-medium text-gray-700">Dosage:</label>
            <input type="text" id="dosage" name="dosage" required class="mt-1 p-2 w-full border rounded-md">
        </div>
        <div class="form-group mb-4">
            <label for="instructions" class="block text-sm font-medium text-gray-700">Instructions:</label>
            <textarea id="instructions" name="instructions" class="mt-1 p-2 w-full border rounded-md"></textarea>
        </div>
        <div class="flex justify-end gap-4">
            <button type="submit" class="btn btn-primary">Prescribe</button>
            <a href="{{ url_for('view_patient', id=patient.id) }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    document.getElementById("nhsMedicineSearch").addEventListener("input", async function() {
        const query = this.value;
        if (query.length < 2) {
            document.getElementById("nhsMedicineResults").innerHTML = "";
            return;
        }
        try {
            const response = await fetch(`/search_nhs?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            const results = document.getElementById("nhsMedicineResults");
            results.innerHTML = data.results.map(m => `
                <div class="medicine-card bg-gray-50 p-4 rounded-md cursor-pointer" data-name="${m.name}">
                    <h4 class="font-semibold">${m.name}</h4>
                    <p><strong>Description:</strong> ${m.description}</p>
                    <p><strong>Active Ingredients:</strong> ${m.uses.join(", ")}</p>
                    <p><strong>Side Effects:</strong> ${m.side_effects.join(", ")}</p>
                </div>
            `).join("");
            document.querySelectorAll(".medicine-card").forEach(card => {
                card.addEventListener("click", () => {
                    document.getElementById("medication_name").value = card.dataset.name;
                    results.innerHTML = "";
                });
            });
        } catch (error) {
            console.error("Error fetching NHS medicines:", error);
            document.getElementById("nhsMedicineResults").innerHTML = "<p class='text-red-600'>Error fetching medicines.</p>";
        }
    });
</script>
{% endblock %}