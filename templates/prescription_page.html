{% extends "base.html" %}
{% block title %}Prescribe Medication - Township Clinic{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/prescription.css') }}">
{% endblock %}

{% block content %}
<div class="prescription-container">
    <header>
        <h2>Prescribe Medication for {{ patient.first_name }} {{ patient.last_name }}</h2>
        <p>Patient ID: {{ patient.id }}</p>
    </header>
    <form method="POST" action="{{ url_for('prescription_page', patient_id=patient.id) }}">
        <div class="form-group">
            <label for="nhsMedicineSearch">Search NHS Medicines:</label>
            <input type="text" id="nhsMedicineSearch" placeholder="Search for a medicine (e.g., paracetamol)..." autocomplete="off">
            <div id="nhsMedicineResults" class="medicine-results"></div>
        </div>
        <div class="form-group">
            <label for="medication_name">Medication Name:</label>
            <input type="text" id="medication_name" name="medication_name" required>
        </div>
        <div class="form-group">
            <label for="dosage">Dosage:</label>
            <input type="text" id="dosage" name="dosage" required>
        </div>
        <div class="form-group">
            <label for="instructions">Instructions:</label>
            <textarea id="instructions" name="instructions"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Prescribe</button>
        <a href="{{ url_for('patient_profile', patient_id=patient.id) }}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
    document.getElementById("nhsMedicineSearch").addEventListener("input", async function() {
        const query = this.value;
        if (query.length < 2) {
            document.getElementById("nhsMedicineResults").innerHTML = "";
            return;
        }
        try {
            const response = await fetch(`/search_nhs_medicines?query=${encodeURIComponent(query)}`);
            const medicines = await response.json();
            const results = document.getElementById("nhsMedicineResults");
            if (medicines.length === 0) {
                results.innerHTML = "<p>No results found.</p>";
                return;
            }
            results.innerHTML = medicines.map(m => `
                <div class="medicine-card" data-name="${m.name}">
                    <h4>${m.name}</h4>
                    <p><strong>Description:</strong> ${m.description}</p>
                    <p><strong>Active Ingredients:</strong> ${m.uses.join(", ")}</p>
                    <p><strong>Side Effects:</strong> ${m.side_effects.join(", ")}</p>
                </div>
            `).join("");
            document.querySelectorAll(".medicine-card").forEach(card => {
                card.addEventListener("click", () => {
                    document.getElementById("medication_name").value = card.dataset.name;
                    results.innerHTML = "";
                });
            });
        } catch (error) {
            console.error("Error fetching NHS medicines:", error);
            document.getElementById("nhsMedicineResults").innerHTML = "<p>Error fetching medicines.</p>";
        }
    });
</script>
{% endblock %}