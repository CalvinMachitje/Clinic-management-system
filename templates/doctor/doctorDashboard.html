{% extends "base.html" %}
{% block title %}Doctor Dashboard - Township Clinic{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/doctor_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 doctor-dash-container">
    <header class="doctor-dash-header mb-8">
        <h2 class="text-3xl font-bold">üë®‚Äç‚öïÔ∏è Dr. {{ user_details.first_name }} {{ user_details.last_name }}'s Dashboard</h2>
        <p class="text-lg text-gray-600">Welcome back! Here's your overview for {{ now.strftime('%B %d, %Y') }}.</p>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 doctor-dash-top">
        <div class="bg-white rounded-lg shadow-md p-6 doctor-card schedule-card">
            <h3 class="text-xl font-semibold mb-4">Today's Appointments</h3>
            {% if patients_today %}
            <ul class="space-y-4 appointments-list overflow-y-auto max-h-80">
                {% for patient in patients_today %}
                <li class="border-b pb-2">
                    <strong class="text-lg">{{ patient.first_name }} {{ patient.last_name }}</strong> (ID: {{ patient.id }}) 
                    at {{ patient.appointment_time if patient.appointment_time else 'Time TBD' }}
                    <a href="{{ url_for('view_patient', id=patient.id) }}" class="btn btn-primary btn-sm inline-block mt-2">View Profile</a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-center text-gray-600">No appointments for today.</p>
            {% endif %}
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 doctor-card quick-stats-card">
            <h3 class="text-xl font-semibold mb-4">Quick Stats</h3>
            <ul class="space-y-3">
                <li><strong>Total Patients:</strong> {{ total_patients }}</li>
                <li><strong>Chronic Cases:</strong> {{ chronic_patients }}</li>
                <li><strong>Pending Lab Results:</strong> {{ pending_lab_results | default(0) }}</li>
                <li><strong>Unread Messages:</strong> {{ unread_messages | default(0) }}</li>
            </ul>
            <a href="{{ url_for('reception_announcements') }}" class="btn btn-primary btn-block mt-4">View Messages</a>
        </div>
    </section>

    <section class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-xl font-semibold mb-4">Search NHS Conditions</h3>
        <input type="text" id="nhsConditionSearch" placeholder="üîç Search medical conditions (e.g., diabetes)..." autocomplete="off" class="w-full p-2 border rounded-md mb-4">
        <div id="nhsConditionResults" class="medicine-results space-y-4"></div>
    </section>

    <section class="bg-white rounded-lg shadow-md p-6 mb-8 doctor-dash-patients">
        <h3 class="text-xl font-semibold mb-4">Patient Directory</h3>
        <input type="text" id="searchInput" placeholder="üîç Search patients by name or ID..." onkeyup="filterPatients()" autocomplete="off" class="w-full p-2 border rounded-md mb-4">
        <table id="patientsTable" class="w-full table-auto border-collapse">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 text-left">ID</th>
                    <th class="px-4 py-2 text-left">First Name</th>
                    <th class="px-4 py-2 text-left">Last Name</th>
                    <th class="px-4 py-2 text-left">DOB</th>
                    <th class="px-4 py-2 text-left">Gender</th>
                    <th class="px-4 py-2 text-left">Last Visit</th>
                    <th class="px-4 py-2 text-left">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2">{{ patient.id }}</td>
                    <td class="px-4 py-2">{{ patient.first_name }}</td>
                    <td class="px-4 py-2">{{ patient.last_name }}</td>
                    <td class="px-4 py-2">{{ patient.date_of_birth or 'Not specified' }}</td>
                    <td class="px-4 py-2">{{ patient.gender or 'Not specified' }}</td>
                    <td class="px-4 py-2">{{ patient.last_visit_date or 'N/A' }}</td>
                    <td class="px-4 py-2">
                        <a href="{{ url_for('view_patient', id=patient.id) }}" class="btn btn-primary btn-sm">Profile</a>
                        <a href="{{ url_for('prescription_page', patient_id=patient.id) }}" class="btn btn-primary btn-sm">Prescription</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <section class="bg-white rounded-lg shadow-md p-6 doctor-dash-reminders">
        <h3 class="text-xl font-semibold mb-4">Reminders & Alerts</h3>
        {% if reminders %}
        <ul class="space-y-4 reminder-list">
            {% for reminder in reminders %}
            <li class="border-b pb-2">
                <strong>{{ reminder.title }}</strong> ‚Äî <em>{{ reminder.date }}</em><br>
                {{ reminder.description }}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-center text-gray-600">No reminders or alerts at the moment.</p>
        {% endif %}
    </section>
</div>

<script>
    function filterPatients() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const table = document.getElementById("patientsTable");
        const rows = table.tBodies[0].rows;
        for (let row of rows) {
            const firstName = row.cells[1].textContent.toLowerCase();
            const lastName = row.cells[2].textContent.toLowerCase();
            const id = row.cells[0].textContent.toLowerCase();
            row.style.display = (firstName.includes(input) || lastName.includes(input) || id.includes(input)) ? '' : 'none';
        }
    }

    document.getElementById("nhsConditionSearch").addEventListener("input", async function() {
        const query = this.value;
        if (query.length < 2) {
            document.getElementById("nhsConditionResults").innerHTML = "";
            return;
        }
        try {
            const response = await fetch(`/search_nhs?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            const results = document.getElementById("nhsConditionResults");
            results.innerHTML = data.results.map(c => `
                <div class="medicine-card bg-gray-50 p-4 rounded-md mb-4">
                    <h4 class="font-semibold">${c.name}</h4>
                    <p><strong>Description:</strong> ${c.description}</p>
                    <p><strong>Symptoms:</strong> ${c.symptoms.join(", ")}</p>
                    <p><strong>Treatment:</strong> ${c.treatment}</p>
                </div>
            `).join("");
        } catch (error) {
            console.error("Error fetching NHS conditions:", error);
            document.getElementById("nhsConditionResults").innerHTML = "<p class='text-red-600'>Error fetching conditions.</p>";
        }
    });
</script>
{% endblock %}